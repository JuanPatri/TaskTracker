@page "/ProjectResources/{projectId:int}"
@using Backend.Domain
@using Backend.DTOs.ProjectDTOs
@using Backend.Service
@inject ProjectService ProjectService
@inject SessionService Session
@inject NavigationManager Navigation

<h3>Project Resources</h3>

@if (_project == null)
{
    <p>Loading...</p>
}
else
{
    @foreach (var task in _project.Tasks)
    {
        <h5>Task: @task.Title</h5>
        <ul>
            @foreach (var (quantity, resource) in task.Resources)
            {
                <li>
                    <b>@resource.Name</b> - @resource.Description <br />
                    Needed: @quantity

                    @if (quantity > 0)
                    {
                        <button class="btn btn-sm btn-success mt-1" @onclick="() => AssignResource(task.Title, resource.Name)">
                            Assign to me
                        </button>
                    }
                    else
                    {
                        <span class="text-danger">Not available</span>
                    }
                </li>
            }
        </ul>
    }
}

@code {
    [Parameter] public int projectId { get; set; }

    private Project _project;

    protected override void OnInitialized()
    {
        _project = ProjectService.GetProject(new GetProjectDTO { Id = projectId });
    }

    private void AssignResource(string taskTitle, string resourceName)
    {
        var task = _project?.Tasks.FirstOrDefault(t => t.Title == taskTitle);
        if (task != null)
        {
            (int, Resource) resource = task.Resources.FirstOrDefault(r => r.Item2.Name == resourceName);
            if (resource != default && resource.Item1 > 0)
            {
                int index = task.Resources.IndexOf(resource);
                
                task.Resources[index] = (resource.Item1 - 1, resource.Item2);
                
                ProjectService.DecreaseResourceQuantity(projectId, resourceName);
                
                _project = ProjectService.GetProject(new GetProjectDTO { Id = projectId });
            }
        }
    }

}
